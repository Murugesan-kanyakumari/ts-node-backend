name: KaneAI - Auto Trigger Test Runs

on:
  push:
    branches: [ "main" ]

jobs:
  run-kaneai:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: "01K9Q78JG0N13DTGM260ZGFJBD"
      AUTH: "dGVzdGVyc3BvZGlvdHJhY2tlcjp4NXhiaHA3MHZFWGhJOWZyUHBsVElkZldIemtPZ01heklLUHg3ZEN4OGdKMU00eHVGcw=="

    steps:
      - name: Get Test Plans
        id: get-plans
        run: |
          echo "Fetching test plans for project: $PROJECT_ID"

          plans=$(curl -s --location \
            "https://test-manager-api.lambdatest.com/api/atm/v1/projects/$PROJECT_ID/test-plans" \
            --header "accept: application/json" \
            --header "Authorization: Basic $AUTH")

          echo "API Response: $plans"

          plan_id=$(echo "$plans" | jq -r '.data[0].id')

          if [[ "$plan_id" == "null" ]]; then
            echo "❌ No test plans found"
            exit 1
          fi

          echo "PLAN_ID=$plan_id" >> $GITHUB_ENV
          echo "Found Plan: $plan_id"


      - name: Get Test Runs inside that Plan
        id: get-runs
        run: |
          echo "Fetching test runs for plan: $PLAN_ID"

          runs=$(curl -s --location \
            "https://test-manager-api.lambdatest.com/api/atm/v1/test-plans/$PLAN_ID/test-runs" \
            --header "accept: application/json" \
            --header "Authorization: Basic $AUTH")

          echo "API Response: $runs"

          run_id=$(echo "$runs" | jq -r '.data[0].id')

          if [[ "$run_id" == "null" ]]; then
            echo "❌ No test runs found"
            exit 1
          fi

          echo "RUN_ID=$run_id" >> $GITHUB_ENV
          echo "Found Run: $run_id"


      - name: Trigger HyperExecute for this Run
        id: trigger
        run: |
          echo "Triggering HyperExecute run: $RUN_ID"

          resp=$(curl -s --location "https://test-manager-api.lambdatest.com/api/atm/v1/hyperexecute" \
            --header "accept: application/json" \
            --header "Content-Type: application/json" \
            --header "Authorization: Basic $AUTH" \
            --data "{
              \"test_run_id\": \"$RUN_ID\",
              \"concurrency\": 1
            }")

          echo "HE Response: $resp"

          job_id=$(echo "$resp" | jq -r '.job_id')

          if [[ "$job_id" == "null" ]]; then
            echo "❌ Failed to trigger job"
            exit 1
          fi

          echo "JOB_ID=$job_id" >> $GITHUB_ENV
          echo "Triggered Job ID: $job_id"


      - name: Wait and Check Job Status
        run: |
          echo "Waiting for job to complete..."
          sleep 180

          status=$(curl -s \
            "https://api.hyperexecute.cloud/v2.0/job/$JOB_ID" \
            --header "accept: application/json" \
            --header "Authorization: Basic $AUTH")

          echo "Job Response: $status"

          result=$(echo "$status" | jq -r '.data.status')

          echo "Job Status: $result"

          if [[ "$result" != "completed" ]]; then
            echo "❌ Tests failed"
            exit 1
          fi

          echo "✅ Tests PASSED!"
