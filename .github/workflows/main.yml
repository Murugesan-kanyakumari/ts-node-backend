name: Run Latest HyperExecute Tests (DEV Only)

on:
  push:
    branches: [ dev ]     # Runs only for dev branch
  pull_request:
    branches: [ dev ]
  workflow_dispatch:
    inputs:
      project_id:
        description: 'LambdaTest Project ID'
        required: true
        default: '01K9Q78JG0N13DTGM260ZGFJBD'  # You can replace manually

jobs:
  run-latest-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install jq for JSON parsing
      run: sudo apt-get install -y jq

    - name: Get All Test Runs from Project
      id: get-tests
      env:
        PROJECT_ID: ${{ github.event.inputs.project_id }}
        AUTH: "dGVzdGVyc3BvZGlvdHJhY2tlcjp4NXhiaHA3MHZFWGhJOWZyUHBsVElkZldIemtPZ01heklLUHg3ZEN4OGdKMU00eHVGcw=="   # <---- direct paste (no secrets)
      run: |
        echo "ðŸ” Fetching test runs for project: $PROJECT_ID"

        response=$(curl --location \
          "https://test-manager-api.lambdatest.com/api/atm/v1/test-runs?projectId=$PROJECT_ID" \
          --header "accept: application/json" \
          --header "Authorization: Basic $AUTH")

        echo "API Response: $response"

        test_ids=$(echo "$response" | jq -r '.data[].id' | tr '\n' ' ')

        if [ -z "$test_ids" ] || [ "$test_ids" = "null" ]; then
          echo "âŒ No test runs found in project"
          exit 1
        fi

        echo "ðŸ“‹ Found test run IDs: $test_ids"
        echo "test_ids=$test_ids" >> $GITHUB_OUTPUT

    - name: Run All Tests Sequentially
      env:
        TEST_IDS: ${{ steps.get-tests.outputs.test_ids }}
        AUTH: "PASTE_YOUR_AUTH_STRING_HERE"   # <---- direct paste again
      run: |
        echo "ðŸš€ Starting sequential execution of all tests..."

        IFS=' ' read -ra TEST_ID_ARRAY <<< "$TEST_IDS"

        total_tests=${#TEST_ID_ARRAY[@]}
        current_test=1

        echo "ðŸŽ¯ Total tests to run: $total_tests"

        for test_id in "${TEST_ID_ARRAY[@]}"; do
          if [ -n "$test_id" ] && [ "$test_id" != "null" ]; then
            echo "========================================="
            echo "ðŸ”¸ Test $current_test of $total_tests: $test_id"
            echo "========================================="

            trigger_response=$(curl --location \
              'https://test-manager-api.lambdatest.com/api/atm/v1/hyperexecute' \
              --header 'accept: application/json' \
              --header 'Content-Type: application/json' \
              --header "Authorization: Basic $AUTH" \
              --data "{
                \"test_run_id\": \"$test_id\",
                \"concurrency\": 1
              }")

            echo "Trigger Response: $trigger_response"

            job_id=$(echo "$trigger_response" | jq -r '.job_id')

            if [ "$job_id" = "null" ] || [ -z "$job_id" ]; then
              echo "âŒ Failed to trigger test: $test_id"
              current_test=$((current_test + 1))
              continue
            fi

            echo "ðŸ“Š HyperExecute Job ID: $job_id"
            echo "â³ Waiting for job completion..."

            max_attempts=60
            attempt=1
            test_completed=false

            while [ $attempt -le $max_attempts ]; do
              status_response=$(curl --location \
                "https://api.hyperexecute.cloud/v2.0/job/$job_id" \
                --header "accept: application/json" \
                --header "Authorization: Basic $AUTH")

              status=$(echo "$status_response" | jq -r '.data.status')

              case $status in
                "completed")
                  echo "âœ… Test $current_test completed successfully!"
                  test_completed=true
                  break
                  ;;
                "failed"|"error"|"cancelled")
                  echo "âŒ Test $current_test failed with status: $status"
                  test_completed=true
                  break
                  ;;
                *)
                  echo "â±ï¸ Status: $status (Attempt $attempt of $max_attempts)"
                  sleep 30
                  attempt=$((attempt + 1))
                  ;;
              esac
            done

            if [ "$test_completed" = false ]; then
              echo "ðŸ• Timeout after 30 minutes"
            fi

            echo "----------------------------------------"
            current_test=$((current_test + 1))
            sleep 5
          fi
        done

        echo "ðŸŽ‰ All tests execution completed!"
        echo "ðŸ“Š Total tests processed: $((current_test - 1))"

    - name: Final Summary
      if: always()
      run: |
        echo "========================================="
        echo "ðŸ“Š LAMBDATEST HYPEREXECUTE SUMMARY"
        echo "========================================="
        echo "ðŸ¢ Project ID: ${{ github.event.inputs.project_id }}"
        echo "ðŸ•’ Execution time: $(date)"
        echo "ðŸ’¡ Check LambdaTest dashboard for results"
        echo "========================================="
