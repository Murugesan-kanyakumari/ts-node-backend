name: Run All HyperExecute Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: "01K9Q78JG0N13DTGM260ZGFJBD"     # ðŸ”¥ Your project ID here
      AUTH: "Basic dGVzdGVyc3BvZGlvdHJhY2tlcjp4NXhiaHA3MHZFWGhJOWZyUHBsVElkZldIemtPZ01heklLUHg3ZEN4OGdKMU00eHVGcw=="        # ðŸ”¥ Your Base64 auth here

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Fetch all test runs for the project
      id: fetch
      run: |
        echo "Fetching test runs for project: $PROJECT_ID"

        response=$(curl --location \
          "https://test-manager-api.lambdatest.com/api/atm/v1/test-run?project_id=$PROJECT_ID" \
          --header "accept: application/json" \
          --header "Authorization: $AUTH")

        echo "API Response: $response"

        test_ids=$(echo "$response" | jq -r '.data[].id' | tr '\n' ' ')
        
        if [ -z "$test_ids" ]; then
          echo "âŒ No test runs found"
          exit 1
        fi

        echo "Found test runs: $test_ids"
        echo "test_ids=$test_ids" >> $GITHUB_OUTPUT

    - name: Run all HyperExecute tests sequentially
      env:
        TEST_IDS: ${{ steps.fetch.outputs.test_ids }}
      run: |
        IFS=' ' read -ra IDS <<< "$TEST_IDS"
        echo "Running ${#IDS[@]} tests..."

        for id in "${IDS[@]}"; do
          echo "----------------------------------------"
          echo "Triggering test run: $id"
          
          trigger=$(curl --location \
            'https://test-manager-api.lambdatest.com/api/atm/v1/hyperexecute' \
            --header 'accept: application/json' \
            --header 'Content-Type: application/json' \
            --header "Authorization: $AUTH" \
            --data "{
              \"test_run_id\": \"$id\",
              \"concurrency\": 1
            }")

          echo "Trigger response: $trigger"

          job_id=$(echo "$trigger" | jq -r '.job_id')

          if [ -z "$job_id" ] || [ "$job_id" = "null" ]; then
            echo "âŒ Failed to trigger test: $id"
            continue
          fi

          echo "Waiting for HyperExecute job to finish: $job_id"
          sleep 60  # wait before checking status

          status_res=$(curl --location \
            "https://api.hyperexecute.cloud/v2.0/job/$job_id" \
            --header "accept: application/json" \
            --header "Authorization: $AUTH")

          echo "Status response: $status_res"

          status=$(echo "$status_res" | jq -r '.data.status')

          echo "Test status: $status"

          if [[ "$status" != "completed" ]]; then
            echo "âŒ Test FAILED or INCOMPLETE"
            exit 1
          fi

          echo "âœ… Test completed successfully!"
          echo "----------------------------------------"
        done

        echo "ðŸŽ‰ All tests completed successfully!"
