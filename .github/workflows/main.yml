name: Run KaneAI HyperExecute Tests

on:
  push:
    branches: [ main ]

jobs:
  run-kaneai-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install jq for JSON parsing
      run: sudo apt-get install -y jq

    - name: Get All Test Runs from Project
      id: get-tests
      env:
        PROJECT_ID: '01K9Q78JG0N13DTGM260ZGFJBD'  # Your actual project ID
      run: |
        echo "ğŸ” Fetching test runs for project: $PROJECT_ID"
        
        # Try different API endpoints
        echo "Trying API endpoint 1..."
        response1=$(curl --silent --location \
          "https://test-manager.lambdatest.com/api/v1/test-runs?projectId=$PROJECT_ID" \
          --header "accept: application/json" \
          --header "Authorization: Basic dGVzdGVyc3BvZGlvdHJhY2tlcjp4NXhiaHA3MHZFWGhJOWZyUHBsVElkZldIemtPZ01heklLUHg3ZEN4OGdKMU00eHVGcw==" || echo "API_ERROR")
        
        echo "Response 1: $response1"
        
        # If first fails, try alternative endpoint
        if [[ "$response1" == *"404"* ]] || [[ "$response1" == "API_ERROR" ]]; then
          echo "Trying API endpoint 2..."
          response2=$(curl --silent --location \
            "https://api.lambdatest.com/test-manager/v1/test-runs?projectId=$PROJECT_ID" \
            --header "accept: application/json" \
            --header "Authorization: Basic dGVzdGVyc3BvZGlvdHJhY2tlcjp4NXhiaHA3MHZFWGhJOWZyUHBsVElkZldIemtPZ01heklLUHg3ZEN4OGdKMU00eHVGcw==" || echo "API_ERROR")
          
          echo "Response 2: $response2"
          response="$response2"
        else
          response="$response1"
        fi
        
        # Check if we got a valid JSON response
        if echo "$response" | jq . > /dev/null 2>&1; then
          echo "âœ… Valid JSON response received"
          # Extract test run IDs using jq
          test_ids=$(echo "$response" | jq -r '.data[].id' | tr '\n' ' ' 2>/dev/null || echo "")
          
          if [ -z "$test_ids" ]; then
            # Try alternative JSON structure
            test_ids=$(echo "$response" | jq -r '.[].id' | tr '\n' ' ' 2>/dev/null || echo "")
          fi
        else
          echo "âŒ Invalid API response: $response"
          exit 1
        fi
        
        if [ -z "$test_ids" ] || [ "$test_ids" = "null" ]; then
          echo "âŒ No test runs found in project or invalid response format"
          echo "Full response: $response"
          exit 1
        fi
        
        echo "ğŸ“‹ Found test run IDs: $test_ids"
        echo "test_ids=$test_ids" >> $GITHUB_OUTPUT

    - name: Run All KaneAI Tests Sequentially
      env:
        TEST_IDS: ${{ steps.get-tests.outputs.test_ids }}
      run: |
        echo "ğŸš€ Starting sequential execution of all KaneAI HyperExecute tests..."
        
        # Convert space-separated string to array
        IFS=' ' read -ra TEST_ID_ARRAY <<< "$TEST_IDS"
        
        total_tests=${#TEST_ID_ARRAY[@]}
        current_test=1
        
        echo "ğŸ¯ Total KaneAI tests to run: $total_tests"
        
        for test_id in "${TEST_ID_ARRAY[@]}"; do
          if [ -n "$test_id" ] && [ "$test_id" != "null" ]; then
            echo "========================================="
            echo "ğŸ”¸ KaneAI Test $current_test of $total_tests: $test_id"
            echo "========================================="
            
            # Trigger HyperExecute test
            echo "â³ Triggering HyperExecute..."
            trigger_response=$(curl --silent --location \
              'https://test-manager-api.lambdatest.com/api/atm/v1/hyperexecute' \
              --header 'accept: application/json' \
              --header 'Content-Type: application/json' \
              --header "Authorization: Basic dGVzdGVyc3BvZGlvdHJhY2tlcjp4NXhiaHA3MHZFWGhJOWZyUHBsVElkZldIemtPZ01heklLUHg3ZEN4OGdKMU00eHVGcw==" \
              --data "{
                \"test_run_id\": \"$test_id\",
                \"concurrency\": 1
              }")
            
            echo "Trigger Response: $trigger_response"
            
            # Check if trigger was successful
            if [[ "$trigger_response" == *"404"* ]] || [[ "$trigger_response" == *"error"* ]]; then
              echo "âŒ Failed to trigger test (API error): $test_id"
              current_test=$((current_test + 1))
              continue
            fi
            
            # Extract job ID from response
            job_id=$(echo "$trigger_response" | jq -r '.job_id' 2>/dev/null || echo "")
            
            if [ "$job_id" = "null" ] || [ -z "$job_id" ]; then
              echo "âŒ Failed to extract job_id for test: $test_id"
              current_test=$((current_test + 1))
              continue
            fi
            
            echo "ğŸ“Š HyperExecute Job ID: $job_id"
            
            # Wait for test completion with polling
            echo "â³ Waiting for test completion..."
            max_attempts=60  # 30 minutes maximum (60 * 30 seconds)
            attempt=1
            test_completed=false
            
            while [ $attempt -le $max_attempts ]; do
              status_response=$(curl --silent --location \
                "https://api.hyperexecute.cloud/v2.0/job/$job_id" \
                --header "accept: application/json" \
                --header "Authorization: Basic dGVzdGVyc3BvZGlvdHJhY2tlcjp4NXhiaHA3MHZFWGhJOWZyUHBsVElkZldIemtPZ01heklLUHg3ZEN4OGdKMU00eHVGcw==")
              
              # Check if status API call was successful
              if [[ "$status_response" == *"404"* ]] || [[ "$status_response" == *"error"* ]]; then
                echo "âš ï¸ Error checking status (Attempt $attempt)"
                sleep 30
                attempt=$((attempt + 1))
                continue
              fi
              
              status=$(echo "$status_response" | jq -r '.data.status' 2>/dev/null || echo "unknown")
              
              case $status in
                "completed")
                  echo "âœ… KaneAI Test $current_test completed successfully!"
                  test_completed=true
                  break
                  ;;
                "failed"|"error"|"cancelled")
                  echo "âŒ KaneAI Test $current_test failed with status: $status"
                  test_completed=true
                  break
                  ;;
                "unknown")
                  echo "âš ï¸ Unknown status response (Attempt $attempt)"
                  ;;
                *)
                  echo "â±ï¸ Status: $status (Attempt $attempt of $max_attempts)"
                  sleep 30
                  attempt=$((attempt + 1))
                  ;;
              esac
            done
            
            if [ "$test_completed" = false ]; then
              echo "ğŸ• KaneAI Test $current_test timed out after 30 minutes"
            fi
            
            echo "----------------------------------------"
            current_test=$((current_test + 1))
            sleep 5  # Small delay between tests
          fi
        done
        
        echo "ğŸ‰ All KaneAI tests execution completed!"
        echo "ğŸ“Š Total KaneAI tests processed: $((current_test - 1))"

    - name: KaneAI Tests Summary
      if: always()
      run: |
        echo "========================================="
        echo "ğŸ“Š KANEAI HYPEREXECUTE SUMMARY"
        echo "========================================="
        echo "ğŸ¢ Project ID: 01K9Q78JG0N13DTGM260ZGFJBD"
        echo "ğŸ•’ Execution time: $(date)"
        echo "âœ… KaneAI test execution completed"
        echo "ğŸ“‹ Check LambdaTest dashboard for detailed results"
        echo "========================================="
